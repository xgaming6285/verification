<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-translate="meta.title">
      CreditoPro - Identity Verification
    </title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="verification-styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <a href="index.html"><i class="fas fa-coins"></i> CreditoPro</a>
        </div>

        <div class="nav-menu" id="nav-menu">
          <a
            href="index.html#home"
            class="nav-link"
            data-translate="navigation.home"
            >Home</a
          >
          <a
            href="index.html#calculator"
            class="nav-link"
            data-translate="navigation.calculator"
            >Loans</a
          >
          <a
            href="index.html#how-it-works"
            class="nav-link"
            data-translate="navigation.how_it_works"
            >How it Works</a
          >
          <a
            href="index.html#contact"
            class="nav-link"
            data-translate="navigation.contact"
            >Contact</a
          >

          <div class="language-selector">
            <select id="language-select">
              <option value="bg">BG</option>
              <option value="en" selected>EN</option>
            </select>
          </div>
        </div>

        <div class="hamburger" id="hamburger">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </div>
      </div>
    </nav>

    <!-- Verification Section -->
    <section class="verification-page">
      <div class="container">
        <div class="verification-header-page">
          <h1>
            <i class="fas fa-shield-check"></i>
            <span data-translate="verification.title"
              >Identity Verification</span
            >
          </h1>
          <p data-translate="verification.subtitle">
            Complete the verification form to finalize your loan application
          </p>
        </div>

        <div class="verification-steps">
          <div class="step-indicator">
            <div class="step-item active" data-step="1">
              <div class="step-number">1</div>
              <span data-translate="verification.steps.personal_info"
                >Personal Info</span
              >
            </div>
            <div class="step-item" data-step="2">
              <div class="step-number">2</div>
              <span data-translate="verification.steps.photo_capture"
                >Photo Capture</span
              >
            </div>
            <div class="step-item" data-step="3">
              <div class="step-number">3</div>
              <span data-translate="verification.steps.complete">Complete</span>
            </div>
          </div>

          <!-- Step 1: Personal Information -->
          <div class="verification-step active" id="step-1">
            <h3 data-translate="verification.step1.title">
              Enter your personal information
            </h3>
            <form id="personal-info-form">
              <div class="form-row">
                <div class="form-group">
                  <label
                    for="first-name"
                    data-translate="verification.step1.first_name"
                    >First Name</label
                  >
                  <input
                    type="text"
                    id="first-name"
                    name="firstName"
                    required
                  />
                </div>
                <div class="form-group">
                  <label
                    for="last-name"
                    data-translate="verification.step1.last_name"
                    >Last Name</label
                  >
                  <input type="text" id="last-name" name="lastName" required />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="egn" data-translate="verification.step1.egn"
                    >Personal ID Number</label
                  >
                  <input
                    type="text"
                    id="egn"
                    name="egn"
                    maxlength="10"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="phone" data-translate="verification.step1.phone"
                    >Phone</label
                  >
                  <input type="tel" id="phone" name="phone" required />
                </div>
              </div>

              <div class="form-group">
                <label for="email" data-translate="verification.step1.email"
                  >Email Address</label
                >
                <input type="email" id="email" name="email" required />
              </div>

              <div class="form-group">
                <label for="address" data-translate="verification.step1.address"
                  >Address</label
                >
                <textarea
                  id="address"
                  name="address"
                  rows="3"
                  required
                ></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="income" data-translate="verification.step1.income"
                    >Monthly Income (BGN)</label
                  >
                  <input
                    type="number"
                    id="income"
                    name="income"
                    min="0"
                    required
                  />
                </div>
                <div class="form-group">
                  <label
                    for="employment"
                    data-translate="verification.step1.employment"
                    >Employment Status</label
                  >
                  <select id="employment" name="employment" required>
                    <option
                      value=""
                      data-translate="verification.step1.employment_options.select"
                    >
                      Select
                    </option>
                    <option
                      value="employed"
                      data-translate="verification.step1.employment_options.employed"
                    >
                      Employed
                    </option>
                    <option
                      value="self-employed"
                      data-translate="verification.step1.employment_options.self_employed"
                    >
                      Self-employed
                    </option>
                    <option
                      value="retired"
                      data-translate="verification.step1.employment_options.retired"
                    >
                      Retired
                    </option>
                    <option
                      value="unemployed"
                      data-translate="verification.step1.employment_options.unemployed"
                    >
                      Unemployed
                    </option>
                  </select>
                </div>
              </div>

              <button type="button" class="next-btn" onclick="nextStep(2)">
                <span data-translate="verification.step1.continue"
                  >Continue</span
                >
                <i class="fas fa-arrow-right"></i>
              </button>
            </form>
          </div>

          <!-- Step 2: Camera Photo Capture -->
          <div class="verification-step" id="step-2">
            <h3 data-translate="verification.step2.title">
              Capture Required Photos
            </h3>
            <p
              class="section-description"
              data-translate="verification.step2.description"
            >
              Follow the guided process to capture all required photos using
              your camera
            </p>

            <div class="photo-capture-progress">
              <div class="progress-indicator">
                <div class="progress-step active" data-photo="1">
                  <div class="progress-number">1</div>
                  <span data-translate="verification.step2.photo1"
                    >ID Front</span
                  >
                </div>
                <div class="progress-step" data-photo="2">
                  <div class="progress-number">2</div>
                  <span data-translate="verification.step2.photo2"
                    >ID Back</span
                  >
                </div>
                <div class="progress-step" data-photo="3">
                  <div class="progress-number">3</div>
                  <span data-translate="verification.step2.photo3"
                    >Selfie with ID Front</span
                  >
                </div>
                <div class="progress-step" data-photo="4">
                  <div class="progress-number">4</div>
                  <span data-translate="verification.step2.photo4"
                    >Selfie with ID Back</span
                  >
                </div>
                <div class="progress-step" data-photo="5">
                  <div class="progress-number">5</div>
                  <span data-translate="verification.step2.photo5"
                    >Selfie Only</span
                  >
                </div>
              </div>
            </div>

            <!-- Photo Navigation -->
            <div
              class="photo-navigation"
              id="photo-navigation"
              style="display: none"
            >
              <h4>Photo Progress</h4>
              <div class="nav-photos" id="nav-photos">
                <!-- Navigation photos will be inserted here -->
              </div>
            </div>

            <!-- Current Capture Section -->
            <div class="current-capture-section" id="current-capture-section">
              <div class="capture-instructions" id="capture-instructions">
                <div class="instruction-icon">
                  <i class="fas fa-id-card"></i>
                </div>
                <h4
                  id="instruction-title"
                  data-translate="verification.step2.instructions.id_front_title"
                >
                  Capture Front Side of ID
                </h4>
                <p
                  id="instruction-text"
                  data-translate="verification.step2.instructions.id_front_text"
                >
                  Position your ID card's front side in the frame and capture a
                  clear photo
                </p>
                <div class="camera-tips">
                  <div class="tip-item">
                    <i class="fas fa-lightbulb"></i>
                    <span data-translate="verification.step2.tips.lighting"
                      >Ensure good lighting</span
                    >
                  </div>
                  <div class="tip-item">
                    <i class="fas fa-hand-paper"></i>
                    <span data-translate="verification.step2.tips.steady"
                      >Keep the camera steady</span
                    >
                  </div>
                  <div class="tip-item">
                    <i class="fas fa-eye"></i>
                    <span data-translate="verification.step2.tips.readable"
                      >Make sure text is readable</span
                    >
                  </div>
                </div>
              </div>

              <div class="capture-controls">
                <button
                  type="button"
                  class="camera-start-btn"
                  id="start-camera-btn"
                  onclick="startCameraCapture()"
                >
                  <i class="fas fa-video"></i>
                  <span data-translate="verification.step2.start_camera"
                    >Start Camera</span
                  >
                </button>
              </div>
            </div>

            <!-- Results Page -->
            <div class="results-page" id="results-page" style="display: none">
              <div class="results-header">
                <h3>Review Your Photos</h3>
                <p>You can retake any photo or submit your application</p>
              </div>
              <div class="results-grid" id="results-grid">
                <!-- Result photos will be inserted here -->
              </div>
              <div class="results-actions">
                <button
                  type="button"
                  class="submit-all-btn"
                  onclick="proceedToVerification()"
                >
                  <span>Submit All Photos</span>
                  <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <div class="step-navigation">
              <button type="button" class="prev-btn" onclick="prevStep(1)">
                <i class="fas fa-arrow-left"></i>
                <span data-translate="verification.step2.back">Back</span>
              </button>
              <button
                type="button"
                class="next-btn"
                id="continue-to-complete"
                onclick="nextStep(3)"
                style="display: none"
              >
                <span data-translate="verification.step2.continue"
                  >Continue</span
                >
                <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>

          <!-- Full Screen Camera -->
          <div class="camera-capture-area" id="camera-capture-area">
            <div class="camera-header">
              <div class="camera-step-info">
                <h5 id="camera-step-title">Capture ID Front</h5>
                <p id="camera-step-description">
                  Position your ID card in the guide
                </p>
              </div>
              <button class="camera-close-btn" onclick="closeCameraCapture()">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <video
              id="capture-video"
              autoplay
              muted
              playsinline
              webkit-playsinline
              style="display: none"
            ></video>
            <canvas id="capture-canvas" style="display: none"></canvas>

            <div class="camera-placeholder" id="camera-placeholder">
              <i class="fas fa-camera"></i>
              <p>Loading camera...</p>
            </div>

            <div
              class="camera-overlay"
              id="camera-overlay"
              style="display: none"
            >
              <!-- Guide overlays will be dynamically inserted here -->
            </div>

            <!-- Capture button positioned over the camera view -->
            <button
              type="button"
              class="capture-photo-btn hidden"
              id="capture-photo-btn"
              onclick="captureCurrentPhoto()"
            >
              <i class="fas fa-camera"></i>
              <span>Capture Photo</span>
            </button>
          </div>

          <!-- Step 3: Complete -->
          <div class="verification-step" id="step-3">
            <div class="complete-content">
              <div class="complete-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3 data-translate="verification.step3.title">All Set!</h3>
              <p data-translate="verification.step3.description">
                Your verification photos have been captured successfully. We're
                now processing your application.
              </p>

              <div class="captured-summary">
                <h4 data-translate="verification.step3.summary_title">
                  Captured Photos:
                </h4>
                <div class="photo-summary-grid" id="photo-summary"></div>
              </div>

              <div class="processing-info">
                <div class="processing-steps">
                  <h4 data-translate="verification.step3.next_steps">
                    What happens next:
                  </h4>
                  <ol>
                    <li data-translate="verification.step3.step_list.step1">
                      We will review your photos and information
                    </li>
                    <li data-translate="verification.step3.step_list.step2">
                      You'll receive an email with the decision
                    </li>
                    <li data-translate="verification.step3.step_list.step3">
                      Upon approval, funds will be transferred
                    </li>
                  </ol>
                </div>

                <div class="contact-info">
                  <p data-translate="verification.step3.contact_info">
                    For questions, contact us:
                  </p>
                  <p>
                    <i class="fas fa-phone"></i>
                    <span data-translate="contact.phone">0700 12 345</span>
                  </p>
                  <p>
                    <i class="fas fa-envelope"></i>
                    <span data-translate="contact.email"
                      >info@creditopro.bg</span
                    >
                  </p>
                </div>
              </div>

              <div class="final-actions">
                <button
                  type="button"
                  class="submit-application-btn"
                  onclick="submitApplication()"
                >
                  <span data-translate="verification.step3.submit"
                    >Submit Application</span
                  >
                  <i class="fas fa-paper-plane"></i>
                </button>
                <button
                  type="button"
                  class="back-home-btn"
                  onclick="window.location.href='index.html'"
                  style="display: none"
                >
                  <span data-translate="verification.step3.back_home"
                    >Back to Home</span
                  >
                  <i class="fas fa-home"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script src="js/translation-manager.js"></script>
    <script src="js/video-recorder.js"></script>
    <script src="verification.js"></script>

    <script>
      // Initialize video recording when verification page loads
      document.addEventListener("DOMContentLoaded", async function () {
        console.log(
          "🔍 Verification page loaded - checking video recording..."
        );

        // Get existing session ID from localStorage
        let sessionId = localStorage.getItem("kyc_session_id");
        if (!sessionId) {
          sessionId = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            function (c) {
              var r = (Math.random() * 16) | 0,
                v = c == "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
          localStorage.setItem("kyc_session_id", sessionId);
        }

        // Check if video recording is already active
        if (!window.videoRecordingManager.isRecording) {
          try {
            // Initialize and start recording for this page
            const initialized =
              await window.videoRecordingManager.initializeSession(sessionId);

            if (initialized) {
              setTimeout(async () => {
                try {
                  await window.videoRecordingManager.startRecording();
                  console.log("✅ Verification page video recording started");
                } catch (error) {
                  console.warn(
                    "⚠️ Could not start video recording on verification page:",
                    error.message
                  );
                }
              }, 1000); // 1 second delay for verification page
            }
          } catch (error) {
            console.warn(
              "⚠️ Video recording initialization failed on verification page:",
              error.message
            );
          }
        } else {
          console.log("ℹ️ Video recording already active - continuing session");
        }
      });

      // Stop recording when user leaves the verification page
      window.addEventListener("beforeunload", function () {
        if (
          window.videoRecordingManager &&
          window.videoRecordingManager.isRecording
        ) {
          window.videoRecordingManager.stopRecording();
        }
      });
    </script>
  </body>
</html>
